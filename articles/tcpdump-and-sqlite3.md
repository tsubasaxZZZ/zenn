---
title: "tcpdump ã®ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã‚’ SQLite ã«å–ã‚Šè¾¼ã‚“ã§ã¿ã‚‹"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["network", "sqlite", "wireshark"]
published: true
---

# ã“ã‚Œã¯ä½•ã‹

ã‚¯ãƒ©ã‚¦ãƒ‰å…¨ç››ã®æ™‚ä»£ã§ã‚‚ã‚„ã£ã±ã‚Šå¤§æ´»èºãª tcpdumpã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é–¢ã™ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã«ã¯å¿…é ˆã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
ãƒ‘ã‚±ãƒƒãƒˆã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ¼ã¯å–å¾—ã—ã¦ã‹ã‚‰ãŒæœ¬ç•ªãªã‚ã‘ã§ã™ãŒã€ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ãã®ä»–ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’ä½¿ã£ã¦ã”ã«ã‚‡ã”ã«ã‚‡ã—å§‹ã‚ã‚‹ã¨ã€æ•´å½¢ã‚„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«è¾›ã¿ã‚’æ„Ÿã˜ã¦ãã¾ã™ã€‚

ãã“ã§ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„æ“ä½œã‚’æ¸›ã‚‰ã™ãŸã‚ã«ã€SQLite ã«å–ã‚Šè¾¼ã‚“ã§ã¿ã¾ã™ã€‚

# 1. pcap ã‹ã‚‰ CSV ã¸ã®å¤‰æ›

SQLite ã§ã¯ã€CSV ã‚’ãã®ã¾ã¾ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ç´ æ™´ã‚‰ã—ã„æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚ ã§ã™ã®ã§ã€ä¸€åº¦ pcap ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ CSV ã«ã—ã¾ã™ã€‚
CSV ã¸ã®å¤‰æ›ã¯ã©ã‚“ãªæ–¹æ³•ã§ã‚‚ã„ã„ã®ã§ã™ãŒã€Wireshark ã‚’ä½¿ã†ã®ãŒä¸€ç•ªç°¡å˜ã§ã—ã‚‡ã†ã€‚

Wireshark ã§ã¯ã€ç”»é¢ã«è¡¨ç¤ºã—ã¦ã„ã‚‹ã¾ã¾ã®ã‚«ãƒ©ãƒ ã§ CSV ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã‚‹ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—CSV ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

è¿½åŠ ã—ãŸã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ "åˆ—ã¨ã—ã¦é©ç”¨" ã™ã‚‹ã¨

![](https://storage.googleapis.com/zenn-user-upload/66beb1838a5a5dddfc67280b.png)

è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/c2fa6f9cff012e61f7d49fb7.png)

ã“ã‚Œã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c886377948709b38c1972b3b.png)
![](https://storage.googleapis.com/zenn-user-upload/eeed9d55be55a15c8a13753c.png)

ç„¡äº‹ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã¾ã—ãŸã€‚

```
$ head zenn.csv
"No.","Time","Time Delta","Source","Destination","Protocol","Length","Info","Sequence Number","Next Sequence Number","Acknowledgment Number","Coloring Rule Name"
"1","2021-08-19 23:34:00.758915","2021-08-19 23:34:00.758915","172.18.225.3","172.18.224.1","TCP","71","38775  >  62715 [PSH, ACK] Seq=591882594 Ack=2357872891 Win=24571 Len=15","591882594","591882609","2357872891","TCP"
"2","2021-08-19 23:34:00.799190","2021-08-19 23:34:00.799190","172.18.224.1","172.18.225.3","TCP","56","62715  >  38775 [ACK] Seq=2357872891 Ack=591882609 Win=8212 Len=0","2357872891","2357872891","591882609","TCP"
"3","2021-08-19 23:34:01.420316","2021-08-19 23:34:01.420316","172.18.225.3","172.18.224.1","TCP","71","38775  >  54992 [PSH, ACK] Seq=166082811 Ack=269735427 Win=24571 Len=15","166082811","166082826","269735427","TCP"
"4","2021-08-19 23:34:01.461169","2021-08-19 23:34:01.461169","172.18.224.1","172.18.225.3","TCP","56","54992  >  38775 [ACK] Seq=269735427 Ack=166082826 Win=8211 Len=0","269735427","269735427","166082826","TCP"
"5","2021-08-19 23:34:01.929891","2021-08-19 23:34:01.929891","172.18.224.1","239.255.255.250","SSDP","145","M-SEARCH * HTTP/1.1 ","","","","UDP"
"6","2021-08-19 23:34:02.294112","2021-08-19 23:34:02.294112","172.18.224.1","172.18.225.3","TCP","75","62715  >  38775 [PSH, ACK] Seq=2357872891 Ack=591882609 Win=8212 Len=19","2357872891","2357872910","591882609","TCP"
"7","2021-08-19 23:34:02.294163","2021-08-19 23:34:02.294163","172.18.225.3","172.18.224.1","TCP","56","38775  >  62715 [ACK] Seq=591882609 Ack=2357872910 Win=24571 Len=0","591882609","591882609","2357872910","TCP"
"8","2021-08-19 23:34:02.421142","2021-08-19 23:34:02.421142","172.18.224.1","172.18.225.3","DNS","163","Standard query response 0x92d2 No such name PTR 160.122.171.52.in-addr.arpa SOA ns1-201.azure-dns.com","","","","UDP"
"9","2021-08-19 23:34:02.421142","2021-08-19 23:34:02.421142","172.18.224.1","172.18.225.3","DNS","163","Standard query response 0x92d2 No such name PTR 160.122.171.52.in-addr.arpa SOA ns1-201.azure-dns.com","","","","UDP"
```

:::message
Frame ã® Coloring Rule Name ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦ãŠãã¨å¾Œã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹ã¨ãã«ä¾¿åˆ©ã§ã™ã€‚
:::

# 2. SQLite ã« CSV ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

SQLite ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ãƒ¯ãƒ³ãƒ©ã‚¤ãƒŠãƒ¼ã§ã§ãã¾ã™ã€‚

```bash
# sqlite3 -separator <ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼> <ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«> ".import <CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹> <ãƒ†ãƒ¼ãƒ–ãƒ«å>"
sqlite3 -separator , zenn.sqlite3 ".import zenn.csv zenn_cap"
```

ã¡ã‚ƒã‚“ã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ããŸã‹è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```bash
$ sqlite3 zenn.sqlite3 ".schema zenn_cap"
CREATE TABLE zenn_cap(
  "No." TEXT,
  "Time" TEXT,
  "Time Delta" TEXT,
  "Source" TEXT,
  "Destination" TEXT,
  "Protocol" TEXT,
  "Length" TEXT,
  "Info" TEXT,
  "Sequence Number" TEXT,
  "Next Sequence Number" TEXT,
  "Acknowledgment Number" TEXT,
  "Coloring Rule Name" TEXT
);
```

ç´ æ™´ã‚‰ã—ã„ã“ã¨ã«ã€SQLite ã¯ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ãã« CSV ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¦‹ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚­ãƒ¼ãƒã‚’è‡ªå‹•çš„ã«ä½œã£ã¦ãã‚Œã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã‚‚è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## ã¨ã‚Šã‚ãˆãš 10 ä»¶
```bash
$ sqlite3 zenn.sqlite3 "select * from zenn_cap limit 10;"
1|2021-08-19 23:34:00.758915|2021-08-19 23:34:00.758915|172.18.225.3|172.18.224.1|TCP|71|38775  >  62715 [PSH, ACK] Seq=591882594 Ack=2357872891 Win=24571 Len=15|591882594|591882609|2357872891|TCP
2|2021-08-19 23:34:00.799190|2021-08-19 23:34:00.799190|172.18.224.1|172.18.225.3|TCP|56|62715  >  38775 [ACK] Seq=2357872891 Ack=591882609 Win=8212 Len=0|2357872891|2357872891|591882609|TCP
3|2021-08-19 23:34:01.420316|2021-08-19 23:34:01.420316|172.18.225.3|172.18.224.1|TCP|71|38775  >  54992 [PSH, ACK] Seq=166082811 Ack=269735427 Win=24571 Len=15|166082811|166082826|269735427|TCP
4|2021-08-19 23:34:01.461169|2021-08-19 23:34:01.461169|172.18.224.1|172.18.225.3|TCP|56|54992  >  38775 [ACK] Seq=269735427 Ack=166082826 Win=8211 Len=0|269735427|269735427|166082826|TCP
5|2021-08-19 23:34:01.929891|2021-08-19 23:34:01.929891|172.18.224.1|239.255.255.250|SSDP|145|M-SEARCH * HTTP/1.1 ||||UDP
6|2021-08-19 23:34:02.294112|2021-08-19 23:34:02.294112|172.18.224.1|172.18.225.3|TCP|75|62715  >  38775 [PSH, ACK] Seq=2357872891 Ack=591882609 Win=8212 Len=19|2357872891|2357872910|591882609|TCP
7|2021-08-19 23:34:02.294163|2021-08-19 23:34:02.294163|172.18.225.3|172.18.224.1|TCP|56|38775  >  62715 [ACK] Seq=591882609 Ack=2357872910 Win=24571 Len=0|591882609|591882609|2357872910|TCP
8|2021-08-19 23:34:02.421142|2021-08-19 23:34:02.421142|172.18.224.1|172.18.225.3|DNS|163|Standard query response 0x92d2 No such name PTR 160.122.171.52.in-addr.arpa SOA ns1-201.azure-dns.com||||UDP
9|2021-08-19 23:34:02.421142|2021-08-19 23:34:02.421142|172.18.224.1|172.18.225.3|DNS|163|Standard query response 0x92d2 No such name PTR 160.122.171.52.in-addr.arpa SOA ns1-201.azure-dns.com||||UDP
10|2021-08-19 23:34:02.421173|2021-08-19 23:34:02.421173|172.18.225.3|172.18.224.1|ICMP|191|Destination unreachable (Port unreachable)||||ICMP errors
```

## HTTP ã ã‘
```bash
$ sqlite3 zenn.sqlite3 'select * from zenn_cap where "Coloring Rule Name" like "HTTP" limit 10;'
25|2021-08-19 23:34:05.482652|2021-08-19 23:34:05.482652|172.18.225.3|142.250.206.196|TCP|76|55370  >  80 [SYN] Seq=1885173153 Win=64240 Len=0 MSS=1460 SACK_PERM=1 TSval=1880965479 TSecr=0 WS=128|1885173153|1885173154|0|HTTP
26|2021-08-19 23:34:05.496954|2021-08-19 23:34:05.496954|142.250.206.196|172.18.225.3|TCP|76|80  >  55370 [SYN, ACK] Seq=10651938 Ack=1885173154 Win=65535 Len=0 MSS=1414 SACK_PERM=1 TSval=1122153421 TSecr=1880965479 WS=256|10651938|10651939|1885173154|HTTP
27|2021-08-19 23:34:05.497014|2021-08-19 23:34:05.497014|172.18.225.3|142.250.206.196|TCP|68|55370  >  80 [ACK] Seq=1885173154 Ack=10651939 Win=64256 Len=0 TSval=1880965493 TSecr=1122153421|1885173154|1885173154|10651939|HTTP
28|2021-08-19 23:34:05.497062|2021-08-19 23:34:05.497062|172.18.225.3|142.250.206.196|HTTP|146|GET / HTTP/1.1 |1885173154|1885173232|10651939|HTTP
29|2021-08-19 23:34:05.510158|2021-08-19 23:34:05.510158|142.250.206.196|172.18.225.3|TCP|68|80  >  55370 [ACK] Seq=10651939 Ack=1885173232 Win=65536 Len=0 TSval=1122153434 TSecr=1880965493|10651939|10651939|1885173232|HTTP
31|2021-08-19 23:34:05.595697|2021-08-19 23:34:05.595697|142.250.206.196|172.18.225.3|TCP|1470|80  >  55370 [ACK] Seq=10651939 Ack=1885173232 Win=65536 Len=1402 TSval=1122153520 TSecr=1880965493 [TCP segment of a reassembled PDU]|10651939|10653341|1885173232|HTTP
32|2021-08-19 23:34:05.595712|2021-08-19 23:34:05.595712|172.18.225.3|142.250.206.196|TCP|68|55370  >  80 [ACK] Seq=1885173232 Ack=10653341 Win=64128 Len=0 TSval=1880965592 TSecr=1122153520|1885173232|1885173232|10653341|HTTP
33|2021-08-19 23:34:05.595739|2021-08-19 23:34:05.595739|142.250.206.196|172.18.225.3|TCP|2872|80  >  55370 [ACK] Seq=10653341 Ack=1885173232 Win=65536 Len=2804 TSval=1122153520 TSecr=1880965493 [TCP segment of a reassembled PDU]|10653341|10656145|1885173232|HTTP
34|2021-08-19 23:34:05.595746|2021-08-19 23:34:05.595746|172.18.225.3|142.250.206.196|TCP|68|55370  >  80 [ACK] Seq=1885173232 Ack=10656145 Win=62720 Len=0 TSval=1880965592 TSecr=1122153520|1885173232|1885173232|10656145|HTTP
35|2021-08-19 23:34:05.596038|2021-08-19 23:34:05.596038|142.250.206.196|172.18.225.3|TCP|9882|80  >  55370 [ACK] Seq=10656145 Ack=1885173232 Win=65536 Len=9814 TSval=1122153520 TSecr=1880965493 [TCP segment of a reassembled PDU]|10656145|10665959|1885173232|HTTP
```

## ã‚µãƒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ã£ã¦ã¿ã‚‹
å®Ÿéš›èª¿æŸ»ã‚’ã—ãŸã¨ãã®ã‚¯ã‚¨ãƒªã‚’ãã®ã¾ã¾å¼•ã£å¼µã£ã¦ããŸã®ã§ä½•ã‚’ã‚„ã‚ŠãŸã„ã®ã‹ã‚ˆãåˆ†ã‹ã‚‰ãªã„ã¨æ€ã„ã¾ã™ãŒã€‚

```
sqlite3 tcpdump.sqlite3 "select * from tcpdump where [Acknowledgment Number] in (select [Next Sequence Number] from tcpdump where Info like '%10000%') and Info like '%FIN%';"
```

# æœ€å¾Œã«

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«å…¨éƒ¨ä»»ã›ã‚‹ã®ã‚‚ã„ã„ã§ã™ãŒã€æ•´å½¢ã—ãŸã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã—ãŸã‚Šã‚’ SQL æ–‡ã«é–‰ã˜è¾¼ã‚ã‚‹ã“ã¨ãŒå‡ºæ¥ã‚‹ã®ã§ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã”ã¨ã«ãã®è¾ºã®å‡¦ç†ã‚’æ›¸ã‹ãªãã¦ã‚ˆããªã‚Šã¾ã—ãŸã€‚